# .github/workflows/update_all_data.yml

name: Update All Ticker Data (Daily)

on:
    # 매일 UTC 20:00 (한국 시간 오전 5시)에 실행
    schedule:
        - cron: '0 20 * * *'
    workflow_dispatch:

permissions:
    contents: write

jobs:
    update-all:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout main branch
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: '3.11'
                  cache: 'pip'
                  cache-dependency-path: 'requirements.txt'

            - name: Install Node.js dependencies
              run: npm install

            - name: Install Python dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt

            # --- 데이터 업데이트 파이프라인 ---
            - name: 1. Get date information
              id: get_date_info
              run: |
                  echo "DAY_OF_MONTH=$(date +'%d')" >> $GITHUB_OUTPUT

            # - name: 2. Fetch top tickers (Monthly)
            #   if: steps.get_date_info.outputs.DAY_OF_MONTH == '01'
            #   run: |
            #       python scripts/fetch_top_tickers.py
            #       python scripts/fetch_us_etfs.py
            #       python scripts/fetch_kr_etfs.py

            - name: 3. Update exchange rate data
              run: node scripts/fetch_all_exchange_rates.js

            - name: 4. Sync IPO dates and upcoming status
              run: npm run add-ipo-dates

            - name: 5. Analyze and add dividend frequency
              run: python scripts/analyze_dividend_frequency.py

            - name: 6. Generate final nav.json
              run: npm run generate-nav

            - name: 7. Update historical price data
              run: npm run update-data

            - name: 8. Update historical dividend data
              run: python scripts/update_dividends.py

            - name: 9. Process and enrich dividend history
              run: python scripts/scraper_dividend.py

            - name: 10. Update latest ticker info
              run: python scripts/scraper_info.py

            - name: 11. Aggregate bookmark popularity
              env:
                  FIRESTORE_SA_KEY: ${{ secrets.FIRESTORE_SA_KEY }}
              run: python scripts/aggregate_popularity.py

            - name: 12. Generate calendar events data
              run: npm run generate-calendar-events

            - name: 13. Generate sidebar tickers data
              run: python scripts/generate_sidebar_tickers.py

            - name: 14. Format all generated data files
              run: |
                  npm run format:data
                  npm run format:nav

            # --- 변경 사항 커밋 및 푸시 ---
            - name: Check for file changes
              id: git_status
              run: |
                  if [[ -n "$(git status --porcelain)" ]]; then
                    echo "changes=true" >> $GITHUB_OUTPUT
                  else
                    echo "changes=false" >> $GITHUB_OUTPUT
                  fi

            - name: Commit and push changes
              if: steps.git_status.outputs.changes == 'true'
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
                  git add .
                  # [핵심 수정] 커밋 메시지에 변경된 파일 목록을 포함
                  COMMIT_MSG="⚙️ Auto: Update all ticker data

                  Changed files:
                  $(git status --porcelain)"
                  git commit -m "$COMMIT_MSG"
                  git push
