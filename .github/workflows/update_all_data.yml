# .github/workflows/update_all_data.yml

name: Update All Ticker Data (Daily on Weekdays)

on:
    # ÌïòÎ£® 2Ìöå Ïã§Ìñâ: ÎØ∏Íµ≠ Ï¶ùÏãú ÎßàÍ∞ê ÌõÑ, ÌïúÍµ≠ Ï¶ùÏãú ÎßàÍ∞ê ÌõÑ
    # - ÎØ∏Íµ≠: UTC 21:00 ÎòêÎäî 22:00 (ÏÑúÎ®∏ÌÉÄÏûÑ Ïó¨Î∂ÄÏóê Îî∞Îùº)
    # - ÌïúÍµ≠: UTC 07:30 (Ïó∞Ï§ë ÎèôÏùº)
    schedule:
        - cron: '0 21 * * 1-5' # UTC 21:00 (ÎØ∏Íµ≠ ÏÑúÎ®∏ÌÉÄÏûÑ Ï†ÅÏö© Ïãú: Ïò§Ï†Ñ 6Ïãú KST)
        - cron: '0 22 * * 1-5' # UTC 22:00 (ÎØ∏Íµ≠ ÏÑúÎ®∏ÌÉÄÏûÑ ÎØ∏Ï†ÅÏö© Ïãú: Ïò§Ï†Ñ 7Ïãú KST)
        - cron: '30 7 * * 1-5' # UTC 07:30 (Ïò§ÌõÑ 4Ïãú 30Î∂Ñ KST, ÌïúÍµ≠ Ï¶ùÏãú ÎßàÍ∞ê ÌõÑ)
    workflow_dispatch:

permissions:
    contents: write

jobs:
    update-all:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout main branch
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: '3.11'
                  cache: 'pip'
                  cache-dependency-path: 'requirements.txt'

            - name: Install Node.js dependencies
              run: npm install

            - name: Install Python dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt

            # --- ÏÑúÎ®∏ÌÉÄÏûÑ Í∞êÏßÄ Î∞è Ïä§ÌÇµ Î°úÏßÅ ---
            - name: Check if should run
              id: check_time
              run: |
                  # ÏàòÎèô Ïã§Ìñâ(workflow_dispatch)Ïù∏ Í≤ΩÏö∞ Ìï≠ÏÉÅ Ïã§Ìñâ
                  if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
                    echo "should_run=true" >> $GITHUB_OUTPUT
                    echo "schedule_type=manual" >> $GITHUB_OUTPUT
                    exit 0
                  fi

                  # ÌòÑÏû¨ UTC ÏãúÍ∞ÑÍ≥º Ïõî Ï†ïÎ≥¥
                  UTC_HOUR=$(date -u +%H)
                  UTC_MONTH=$(date -u +%m)
                  UTC_DOW=$(date -u +%u)  # 1-7 (Mon-Sun)

                  # ÌïúÍµ≠ Ï¶ùÏãú ÎßàÍ∞ê ÌõÑ (UTC 07:30)Ïù∏ Í≤ΩÏö∞ Ìï≠ÏÉÅ Ïã§Ìñâ
                  if [ "$UTC_HOUR" = "07" ] || [ "$UTC_HOUR" = "7" ]; then
                    echo "should_run=true" >> $GITHUB_OUTPUT
                    echo "schedule_type=kr_market" >> $GITHUB_OUTPUT
                    exit 0
                  fi

                  # ÎØ∏Íµ≠ Ï¶ùÏãú ÎßàÍ∞ê ÌõÑ (UTC 21:00 ÎòêÎäî 22:00)Ïù∏ Í≤ΩÏö∞
                  if [ "$UTC_HOUR" = "21" ] || [ "$UTC_HOUR" = "22" ]; then
                    # ÏÑúÎ®∏ÌÉÄÏûÑ Í∏∞Í∞Ñ Ï≤¥ÌÅ¨ (3Ïõî 2Ï£ºÏß∏ ÏùºÏöîÏùº Ïù¥ÌõÑ ~ 11Ïõî 1Ï£ºÏß∏ ÏùºÏöîÏùº Ïù¥Ï†Ñ)
                    # Í∞ÑÎã®Ìûà ÏõîÎ°ú ÌåêÎã® (3-10Ïõî: ÏÑúÎ®∏ÌÉÄÏûÑ Ï†ÅÏö©, UTC 21:00)
                    # 11-2Ïõî: ÏÑúÎ®∏ÌÉÄÏûÑ ÎØ∏Ï†ÅÏö©, UTC 22:00
                    if [ "$UTC_MONTH" -ge 3 ] && [ "$UTC_MONTH" -le 10 ]; then
                      # ÏÑúÎ®∏ÌÉÄÏûÑ Ï†ÅÏö© Í∏∞Í∞Ñ: UTC 21:00Îßå Ïã§Ìñâ
                      if [ "$UTC_HOUR" = "21" ]; then
                        echo "should_run=true" >> $GITHUB_OUTPUT
                        echo "schedule_type=us_market_dst" >> $GITHUB_OUTPUT
                      else
                        echo "should_run=false" >> $GITHUB_OUTPUT
                      fi
                    else
                      # ÏÑúÎ®∏ÌÉÄÏûÑ ÎØ∏Ï†ÅÏö© Í∏∞Í∞Ñ: UTC 22:00Îßå Ïã§Ìñâ
                      if [ "$UTC_HOUR" = "22" ]; then
                        echo "should_run=true" >> $GITHUB_OUTPUT
                        echo "schedule_type=us_market_std" >> $GITHUB_OUTPUT
                      else
                        echo "should_run=false" >> $GITHUB_OUTPUT
                      fi
                    fi
                  else
                    # ÏòàÏÉÅÌïòÏßÄ Î™ªÌïú ÏãúÍ∞ÑÎåÄ
                    echo "should_run=false" >> $GITHUB_OUTPUT
                  fi

            # --- Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏ ÌååÏù¥ÌîÑÎùºÏù∏ ---
            # (Ïù¥Ìïò Ïä§ÌÖùÏùÄ ÎèôÏùºÌïòÍ≤å Ïú†ÏßÄ)
            - name: 1. Get date information
              id: get_date_info
              if: steps.check_time.outputs.should_run == 'true'
              run: |
                  echo "DAY_OF_MONTH=$(date +'%d')" >> $GITHUB_OUTPUT

            - name: 3. Update exchange rate data
              if: steps.check_time.outputs.should_run == 'true'
              run: node scripts/fetch_all_exchange_rates.js

            - name: 4. Sync IPO dates and upcoming status
              if: steps.check_time.outputs.should_run == 'true'
              run: npm run add-ipo-dates

            - name: 5. Analyze and add dividend frequency
              if: steps.check_time.outputs.should_run == 'true'
              run: python scripts/analyze_dividend_frequency.py

            - name: 6. Generate final nav.json
              if: steps.check_time.outputs.should_run == 'true'
              run: npm run generate-nav

            - name: 6.5. Auto-detect and update holdings for new tickers
              if: steps.check_time.outputs.should_run == 'true'
              run: |
                  echo "üîç Holdings ÏûêÎèô Í∞êÏßÄ ÏãúÏûë..."
                  python scripts/auto_detect_holdings.py --api --exclude-kr --yes
                  echo "‚úÖ Holdings ÏûêÎèô Í∞êÏßÄ ÏôÑÎ£å"

            - name: 6.6. Fetch ETF holdings data
              if: steps.check_time.outputs.should_run == 'true'
              run: |
                  echo "üìä ETF Holdings Îç∞Ïù¥ÌÑ∞ ÏàòÏßë ÏãúÏûë..."
                  echo "y" | python scripts/fetch_holdings.py
                  echo "‚úÖ ETF Holdings Îç∞Ïù¥ÌÑ∞ ÏàòÏßë ÏôÑÎ£å"

            - name: 7. Update historical price data
              if: steps.check_time.outputs.should_run == 'true'
              run: npm run update-data

            - name: 7.5. Update daily market capitalization (Yahoo Finance)
              if: steps.check_time.outputs.should_run == 'true'
              run: python scripts/update_market_cap.py

            - name: 8. Update historical dividend data
              if: steps.check_time.outputs.should_run == 'true'
              run: python scripts/update_dividends.py

            - name: 9. Process and enrich dividend history
              if: steps.check_time.outputs.should_run == 'true'
              run: python scripts/scraper_dividend.py

            - name: 9.5. Clean and sanitize historical data
              if: steps.check_time.outputs.should_run == 'true'
              run: python scripts/clean_data.py

            - name: 10. Update latest ticker info
              if: steps.check_time.outputs.should_run == 'true'
              run: python scripts/scraper_info.py

            - name: 11. Aggregate bookmark popularity
              if: steps.check_time.outputs.should_run == 'true'
              env:
                  FIRESTORE_SA_KEY: ${{ secrets.FIRESTORE_SA_KEY }}
              run: python scripts/aggregate_popularity.py

            - name: 11.5. Project future expected dividend dates
              if: steps.check_time.outputs.should_run == 'true'
              run: python scripts/project_future_dividends.py

            - name: 12. Generate calendar events data
              if: steps.check_time.outputs.should_run == 'true'
              run: npm run generate-calendar-events

            - name: 13. Generate sidebar tickers data
              if: steps.check_time.outputs.should_run == 'true'
              run: python scripts/generate_sidebar_tickers.py

            - name: 14. Format all generated data files
              if: steps.check_time.outputs.should_run == 'true'
              run: |
                  npm run format:data
                  npm run format:nav
                  npm run format:public

            # --- Î≥ÄÍ≤Ω ÏÇ¨Ìï≠ Ïª§Î∞ã Î∞è Ìë∏Ïãú ---
            - name: Check for file changes
              id: git_status
              if: steps.check_time.outputs.should_run == 'true'
              run: |
                  if [[ -n "$(git status --porcelain)" ]]; then
                    echo "changes=true" >> $GITHUB_OUTPUT
                  else
                    echo "changes=false" >> $GITHUB_OUTPUT
                  fi

            - name: Commit and push changes
              if: steps.check_time.outputs.should_run == 'true' && steps.git_status.outputs.changes == 'true'
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
                  # git pull --rebase
                  git add .
                  COMMIT_MSG="‚öôÔ∏è Auto: Update all ticker data (${{ steps.check_time.outputs.schedule_type }})

                  Changed files:
                  $(git status --porcelain)"
                  git commit -m "$COMMIT_MSG"
                  git push
