# REFACTORED: .github/workflows/update_all_data.yml

name: Update All Ticker Data (Daily)

on:
    # 매일 UTC 20:00 (한국 시간 오전 5시)에 실행
    schedule:
        - cron: '0 20 * * *'
    # GitHub Actions 탭에서 수동으로 실행 가능하도록 설정
    workflow_dispatch:

# Git에 변경 사항을 푸시하기 위해 쓰기 권한을 부여합니다.
permissions:
    contents: write

jobs:
    update-all:
        runs-on: ubuntu-latest

        steps:
            # 1. 리포지토리 코드를 가져옵니다.
            - name: Checkout main branch
              uses: actions/checkout@v4

            # 2. Node.js 환경을 설정합니다.
            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'

            # 3. Python 환경을 설정합니다.
            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: '3.11'
                  cache: 'pip'
                  cache-dependency-path: 'requirements.txt'

            # 4. Node.js 의존성을 설치합니다.
            - name: Install Node.js dependencies
              run: npm install

            # 5. Python 의존성을 설치합니다.
            - name: Install Python dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt

            # --- 데이터 업데이트 파이프라인 (순서가 매우 중요) ---
            # 단계 0: 오늘 날짜 정보를 가져오는 단계
            - name: 0. Get date information
              id: get_date_info
              run: |
                  echo "DAY_OF_WEEK=$(date +'%u')" >> $GITHUB_OUTPUT
                  echo "DAY_OF_MONTH=$(date +'%d')" >> $GITHUB_OUTPUT

            # 단계 1: KOSPI, NASDAQ 상위 티커 목록 가져와서 nav 소스에 추가
            - name: 1. Fetch top market tickers (Monthly)
              if: steps.get_date_info.outputs.DAY_OF_MONTH == '01'
              run: python scripts/fetch_top_tickers.py

            # 단계 2: 실시간 환율 업데이트
            - name: 2. Update historical exchange rate data
              run: node scripts/fetch_all_exchange_rates.js

            # 단계 3: 소스 파일(public/nav/*.json)의 IPO 날짜를 확인하고 'upcoming' 상태를 업데이트합니다.
            - name: 3. Sync IPO dates and upcoming status
              run: npm run add-ipo-dates

            # 단계 4: 배당 데이터를 분석하여 frequency 및 group 자동 할당
            - name: 4. Analyze and add dividend frequency
              run: python scripts/analyze_dividend_frequency.py

            # 단계 5: 업데이트된 소스 파일을 기반으로 최종 nav.json을 생성합니다.
            - name: 5. Generate final nav.json
              run: npm run generate-nav

            # 단계 6: Node.js 스크립트로 과거 '주가' 데이터를 가져옵니다.
            - name: 6. Update historical price data (Node.js/yahoo-finance2)
              run: npm run update-data

            # 단계 7: Python 스크립트로 과거 '배당' 데이터를 가져옵니다.
            - name: 7. Update historical dividend data (Python/yfinance)
              run: python scripts/update_dividends.py

            # 단계 8: Python 스크립트가 미리 생성된 주가/배당 데이터를 사용하여 dividendHistory를 가공합니다.
            - name: 8. Process and enrich dividend history for display
              run: python scripts/scraper_dividend.py

            # 단계 9: Python 스크립트로 최신 시세 및 기업 정보를 가져옵니다.
            - name: 9. Update latest ticker info
              run: python scripts/scraper_info.py

            # 단계 10: Firestore에서 북마크 인기 데이터를 집계하여 popular.json 생성
            - name: 10. Aggregate bookmark popularity from Firestore
              env:
                  FIRESTORE_SA_KEY: ${{ secrets.FIRESTORE_SA_KEY }}
              run: python scripts/aggregate_popularity.py

            # 단계 11: 캘린더 이벤트 데이터 생성
            - name: 11. Generate aggregated calendar events data
              run: npm run generate-calendar-events

            # 단계 12: 사이드바에 표시할 티커 데이터 생성
            - name: 12. Generate aggregated sidebar tickers data
              run: npm run generate-sidebar-tickers

            # 단계 13: 사이드바에 표시할 티커 데이터 생성
            - name: 13. Generate aggregated sidebar tickers data
              run: python scripts/generate_sidebar_tickers.py

            # 단계 14: 변경된 모든 데이터를 일관된 포맷으로 정리
            - name: 14-1. Format generated data files
              run: npm run format:data
            - name: 14-2. Format generated nav files
              run: npm run format:nav

            # --- 변경 사항 커밋 및 푸시 ---
            - name: Check for file changes
              id: git_status
              run: |
                  if [[ -n "$(git status --porcelain)" ]]; then
                    echo "changes=true" >> $GITHUB_OUTPUT
                  else
                    echo "changes=false" >> $GITHUB_OUTPUT
                  fi

            - name: Commit and push changes
              if: steps.git_status.outputs.changes == 'true'
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
                  git add .
                  # [핵심 수정] 커밋 메시지에 변경된 파일 목록을 포함
                  COMMIT_MSG="⚙️ Auto: Update all ticker data

                  Changed files:
                  $(git status --porcelain)"
                  git commit -m "$COMMIT_MSG"
                  git push
