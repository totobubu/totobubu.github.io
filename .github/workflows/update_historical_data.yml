name: Update Historical Data

on:
    schedule:
        - cron: '0 20 * * *'
    workflow_dispatch:

jobs:
    update_data:
        runs-on: ubuntu-latest

        # [핵심 수정] git push를 위한 올바른 권한 설정
        permissions:
            # 저장소 콘텐츠에 대한 쓰기 권한을 직접 부여합니다.
            contents: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: Cache dependencies
              uses: actions/cache@v4
              with:
                  path: node_modules
                  key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-node-

            - name: Install dependencies
              run: npm ci

            - name: Run data update script
              run: npm run update-data

            - name: Check for file changes
              id: git_status
              run: |
                  if [[ -n "$(git status --porcelain)" ]]; then
                    echo "changes=true" >> $GITHUB_OUTPUT
                  else
                    echo "changes=false" >> $GITHUB_OUTPUT
                  fi

            - name: Commit and push changes
              if: steps.git_status.outputs.changes == 'true'
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
                  git add public/historical public/dividends
                  git commit -m "⚙️ Auto: Update historical and dividend data"
                  git push
